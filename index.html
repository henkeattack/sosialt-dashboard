<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <link rel="stylesheet" href="style.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
  <link rel="icon" type="image/png" sizes="32x32" href="./images/favicon-32x32.png">
</head>
<body class="light">
  <header>
  <fb:login-button scopes="email,public_profile,pages_show_list, pages_read_engagement,pages_manage_engagement,pages_read_user_content,read_insights,instagram_manage_insights,instagram_basic,ads_read"
  onlogin="handlefbLogin();">
</fb:login-button>
<div class="status" id="status"></div>
</header>

<div class="wrapper">
  <div class="container1">
    <header>
      <section>
        <!-- Header tittel-->
        <div class="header-headline">
          <div class="header-headline-1">Mangla AS Sosiale Medier Dashboard</div>
          <div class="header-headline-2" id="totalFollowers"></div>
        </div>

        <!-- Dark/light mode toggle-->
        <div class="header-toggler">
          <div style="font-weight: 700;">Visning</div>

        <div class="toggler" id="toggler">
          <div id="toggler-circle" class="toggler-circle"></div>
          </div>
        </div>
      </section>
        <!-- Sosiale Medier Cards Section -->
      <section>
        <div class="col-md-3 col-sm-6 padding-left resp-padding">
          <div class="header-card facebook">
            <div class="header-card-1">
              <span> <img src="images/icon-facebook.svg" alt="" /> </span>
              <span class="header-card-1-name">@YX7ElevenGjovikSyd</span>
            </div>
            <div class="header-card-2" id="followers"></div>
            <div class="header-card-3">Følgere</div>
            <div class="header-card-4">
              <span> <img src="images/icon-up.svg" alt="" /></span>
              <span style="
                color: hsl(163, 72%, 41%);
                font-size: 12px;
                font-weight: 700;
              " id="newFaceFollowers"
              ></span>
            </div>
          </div>
        </div>

        <div class="col-md-3 col-sm-6 padding-left resp-padding">
          <div class="header-card instagram">
            <div class="header-card-1">
              <span> <img src="images/icon-instagram.svg" alt="" /> </span>
              <span class="header-card-1-name">@yx711gjoviksyd</span>
              
            </div>
            <div class="header-card-2" id="instaFollowers"></div>
            <div class="header-card-3">Følgere</div>
            <div class="header-card-4">
              <span> <img src="images/icon-up.svg" alt="" /></span>
              <span style="
                color: hsl(163, 72%, 41%);
                font-size: 12px;
                font-weight: 700;
              " id=oldInstaFollowers></span>
            </div>
          </div>
        </div>
      </section>
    </header>

    <main>
      <div class="col-md-12 padding-left">
        <div class="main-heading">Ukas Trafikk</div>
        </div>

        <div class="row main-row-margin">
          
          <div class="col-md-3">
            <div class="main-card">
              <div class="main-card-top">
                <span>Sidevisninger</span>
                <span><img src="images/icon-facebook.svg" alt=""></span>
                </div>
                <div class="main-card-bottom">
                  <span id="pageStats"></span>
                  <span><img src="images/icon-up.svg" alt=""> 3% </span>
              </div>
            </div>
          </div>
          
          <div class="col-md-3">
            <div class="main-card">
              <div class="main-card-top">
                <span>Likes</span>
                <span><img src="images/icon-facebook.svg" alt=""></span>
                </div>
                <div class="main-card-bottom">
                  <span id="pageLikes"></span>
                  <span><img src="images/icon-up.svg" alt=""> 2% </span>
              </div>
            </div>
          </div>
          
          <div class="col-md-3">
            <div class="main-card">
              <div class="main-card-top">
                <span>Profilvisninger</span>
                <span><img src="images/icon-instagram.svg" alt=""></span>
                </div>
                <div class="main-card-bottom">
                  <span id="instaPageReach"></span>
                  <span><img src="images/icon-up.svg" alt=""> 5% </span>
              </div>
            </div>
          </div>

        <div class="col-md-3">
          <div class="main-card">
            <div class="main-card-top">
              <span>Rekkevidde</span>
              <span><img src="images/icon-instagram.svg" alt=""></span>
              </div>
              <div class="main-card-bottom">
                <span id="instaPageViews"></span>
                <span><img src="images/icon-up.svg" alt=""> 2% </span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  </div>

<h3 class="">Step 1: Hent data</h3>
    <pre class="odd" id="PageInfo"></pre>
    <pre class="even" id="instaPage"></pre>
    <pre class="odd" id="pageStatsWeek"></pre>
    <pre class="odd" id="weeklyPageLikes"></pre>
    <pre class="odd" id="instaPageViewsWeek"></pre>
    <pre class="odd" id="instaPageReachWeek"></pre>

    
<h3 class="">Step 2: Hent Facebook konto</h3>
<pre class="even" id="MyFacebookAccount"></pre>
<h3 class="">Step 3: Hent relaterte Facebook sider</h3>
<pre class="odd" id="MyFacebookAccountInfo"></pre>
<h3 class="">Step 4: Hent Facebook innsikt</h3>
<pre class="even" id="MyFacebookPageInsights"></pre>
<pre class="even" id="pageDemograph"></pre>
<h3 class="">Step 5: Hent insta konto</h3>
<pre class="odd" id="MyInstaBusinessAcc"></pre>
<h3 class="">Step 5: Hent Insta profil</h3>
<pre class="odd" id="MyInstaAccountInfo"></pre>
<pre class= "even" id="MyInstaLikes"></pre>
<h3 class="">Step 6: Hent Insta Innsikt</h3>
<pre class="even" id="MyInstaAccountInsight"></pre>
<h3 class="">Hent utvidet Insta innsikt</h3>
<pre class="odd" id="myInstaLikes"></pre>
<pre class= "odd" id="followerInsight"></pre>
<pre class= "even" id="newInstaFollowers"></pre>
<h3 class="">Step 6: Hent Insta Innlegg</h3>
<pre class="even" id="MyInstaAccountPosts"></pre>
<h3 class="">Step 7: Hent Facebook Innlegg</h3>
<pre class="odd" id="MyFacebookPosts"></pre>

<script type="module">
  //Print json data i dom 
  const printData = (domId, dataObject) => {
        document.getElementById(domId).innerHTML = JSON.stringify(
          dataObject,
          null,
          "\n\t"
        );
      };
    // implementerer data fra js ----->
    import {
      initializeFlow,
      doLogin,
      getAppToken,
      getMyfbAccInfo,
      getMyfbAccPage,
      getMyfbPageInsights,
      getUserDemograph,
      getMyFbInstaBusinessAcc,
      getMyInstagramAccInfo,
      getMyInstaLikes,
      getMyInstagramAccInsight,
      getMyInstagramAccMediaStats,
      getLifetimeInfo,
      getInstaFollowers,
      getMyfbPagePosts
    } from "./js/script.js";

    const appId = "4223696350981884";
    const clientToken = "7ea19420eda210c55d3c38515aef5cd6";
    const loginSuccessFunc = async (responseItem) => {
    const appToken = await getAppToken(
          responseItem.userIdInfo,
          responseItem.accessTokenInfo
        );

        // 2. hent Facebook-konto
        const fbInfo = await getMyfbAccInfo(
          responseItem.userIdInfo,
          responseItem.accessTokenInfo
        );
        printData("MyFacebookAccount", fbInfo);
        // Returner velkomsthilsen
        document.getElementById("status").innerHTML = "Suksessfull login. Velkommen til siden, " + fbInfo.name;
        console.log("My info: " + fbInfo.name);

        // 3. hent relaterte kontoer til FB profil
        const fbAccInfo = await getMyfbAccPage(
          responseItem.userIdInfo,
          responseItem.accessTokenInfo
        );
        printData("MyFacebookAccountInfo", fbAccInfo.data);
        console.log("Henter data: " + fbAccInfo.data[0].name);
        console.log("Antall Følgere: " + fbAccInfo.data[0].followers_count);
        
        // Returnerer FB side-info
        const facebookAccName = fbAccInfo.data[0].name;
        const faceAccFollowers = fbAccInfo.data[0].engagement.count;
        // Denne FUNKER!!!
        document.getElementById("PageInfo").innerHTML = "Your page info: " + facebookAccName;
        document.getElementById("followers").innerHTML = faceAccFollowers;

        // Kode for gjenbruk
        const fbPageAccId = fbAccInfo.data[0].id;
        const fbPageAccesstoken = fbAccInfo.data[0].access_token;

        // 4. hent sidens Facebook Innsikt
        const fbPageInsights = await getMyfbPageInsights(
          fbPageAccId,
          fbPageAccesstoken
        );
        printData("MyFacebookPageInsights", fbPageInsights.data);

        // Returner innsiktsdata
        const facePageViews = fbPageInsights.data[0].values[6].value;
        document.getElementById("pageStats").innerHTML = facePageViews;

        const weeklyFBPageViews = fbPageInsights.data[0].values[0].value;
        document.getElementById("pageStatsWeek").innerHTML = weeklyFBPageViews; 
        console.log(facePageViews - weeklyFBPageViews);

        // Prosentendring
        function getPercentageChange(oldNumber, newNumber){
          var decreaseValue = oldNumber - newNumber;
            return parseInt((decreaseValue / oldNumber) * 100);
        }
        console.log(getPercentageChange(facePageViews, weeklyFBPageViews));

        const fbPageLikes = fbPageInsights.data[2].values[6].value;
        document.getElementById("pageLikes").innerHTML = fbPageLikes;

        const weeklyfbLikes = fbPageInsights.data[2].values[0].value;
        document.getElementById("weeklyPageLikes").innerHTML = weeklyfbLikes;

        const newFaceFollowers = fbPageInsights.data[4].values[6].value;
        document.getElementById("newFaceFollowers").innerHTML = newFaceFollowers + " nye denne uka";

        // Hent følgernes alder og kjønn
        const fbPageFollowers = await getUserDemograph(
          fbPageAccId,
          fbPageAccesstoken
        );
        printData("pageDemograph", fbPageFollowers.data);

        // 5. hent relatert instagram profil 
        const fbInstaInfo = await getMyFbInstaBusinessAcc(
          fbPageAccId,
          fbPageAccesstoken
        );
        printData("MyInstaBusinessAcc", fbInstaInfo);

        // hent instagram info
        const instaProfileInfo = await getMyInstagramAccInfo(
          fbInstaInfo.instagram_business_account.id,
          fbPageAccesstoken
          );
        printData("MyInstaAccountInfo", instaProfileInfo);

        // returner instagram data
        const instaPageName = instaProfileInfo.name;
        const instaFollowersCount = instaProfileInfo.followers_count;
        document.getElementById("instaPage").innerHTML = "Your Instagram Page Name: " + instaPageName;
        document.getElementById("instaFollowers").innerHTML = instaFollowersCount;

        // Legg sammen antall følgere i sosiale medier
        const totalFollowers = (instaFollowersCount, faceAccFollowers) => instaFollowersCount + faceAccFollowers; 
        document.getElementById("totalFollowers").innerHTML = "Totalt Antall Følgere: " + (totalFollowers(instaFollowersCount,faceAccFollowers));

        // 6. hent instagram insikten
        const instaProfileInsight = await getMyInstagramAccInsight(
          fbInstaInfo.instagram_business_account.id,
          fbPageAccesstoken
        );
        printData("MyInstaAccountInsight", instaProfileInsight);
        // Returner innsiktsdata
        document.getElementById("instaPageViews").innerHTML = instaProfileInsight.data[0].values[6].value;
        document.getElementById("instaPageViewsWeek").innerHTML = instaProfileInsight.data[0].values[0].value;

        document.getElementById("instaPageReach").innerHTML = instaProfileInsight.data[1].values[6].value;
        document.getElementById("instaPageReachWeek").innerHTML = instaProfileInsight.data[1].values[0].value;

        // hent Likes
        const instaMediaLikes = await getMyInstaLikes(
          fbInstaInfo.instagram_business_account.id,
          fbPageAccesstoken
        );
        printData("myInstaLikes", instaMediaLikes);

        // hent likes

        // hent insta demografisk brukerdata
        const followerInsight = await getLifetimeInfo(
          fbInstaInfo.instagram_business_account.id,
          fbPageAccesstoken
        );
        printData("followerInsight", followerInsight);

        // henter nye insta-følgere
        const newInstaFollowers = await getInstaFollowers(
          fbInstaInfo.instagram_business_account.id,
          fbPageAccesstoken
        );
        printData("newInstaFollowers", newInstaFollowers);

        // sammenlign insta følgere
        const oldInstaFollowers = newInstaFollowers.data[0].values.map(value => value.value);
        const instaFollowTotal = oldInstaFollowers.reduce(sum, 0);
          function sum(accumulator, value) {
            return accumulator + value;
          }
        document.getElementById("oldInstaFollowers").innerHTML = instaFollowTotal + " nye denne uka"; 

      // hent instagram innlegg
        const instaProfilePosts = await getMyInstagramAccMediaStats(
          fbInstaInfo.instagram_business_account.id,
          fbPageAccesstoken
        );
        printData("MyInstaAccountPosts", instaProfilePosts);

        // 7. hent FB-sidens innlegg
        const fbPagePosts = await getMyfbPagePosts(
          fbPageAccId,
          fbPageAccesstoken
        );
        printData("MyFacebookPosts", fbPagePosts.data);
    };  

    const loginFailFunc = async (responseItem) => {};
      window.flowFacebookData = {
        appId: appId,
        clientToken: clientToken,
        loginSuccessFunc: loginSuccessFunc,
        loginFailFunc: loginFailFunc,
      };
      initializeFlow();
      window.handlefbLogin = doLogin;
      // <-----initialize data
  </script>

<div class="attribution">Laget av Henrik, Sebastian og Morten</div>

<script src="./js/script.js"></script>
</body>
</html>